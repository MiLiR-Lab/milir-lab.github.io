name: PR Result Notify

on:
  workflow_run:
    workflows:
      - "Lint (pre-commit)"
    types:
      - completed

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      MAINTAINERS_EMAIL: ${{ secrets.MAINTAINERS_EMAIL }}
    steps:
      - name: Comment on related PRs
        uses: actions/github-script@v6
        with:
          script: |
            const run = context.payload.workflow_run;
            const prs = run.pull_requests || [];
            const conclusion = run.conclusion || 'unknown';
            const url = run.html_url || '';
            if (prs.length === 0) {
              core.info('No PRs associated with this run.');
            } else {
              for (const pr of prs) {
                const body = `CI workflow **${run.name}** finished with **${conclusion}**.\n\nDetails: ${url}`;
                await github.rest.issues.createComment({owner: context.repo.owner, repo: context.repo.repo, issue_number: pr.number, body});
              }
            }

      - name: Send email to maintainers (if configured)
        if: ${{ env.MAINTAINERS_EMAIL != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_HOST }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "CI: ${{ github.event.workflow_run.name }} - ${{ github.event.workflow_run.conclusion }}"
          to: ${{ secrets.MAINTAINERS_EMAIL }}
          from: ${{ secrets.SMTP_FROM }}
          body: |
            Workflow: ${{ github.event.workflow_run.name }}
            Conclusion: ${{ github.event.workflow_run.conclusion }}
            URL: ${{ github.event.workflow_run.html_url }}
            Associated PRs: ${{ toJson(github.event.workflow_run.pull_requests) }}
